#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# @Date    : 2019-05-13 21:41:36
# @Author  : shenxx (admin@xiangxiang-shen.com)
# @Link    : https://xiangxiang-shen.com
# @Version : 0.1
# TODO 1   : Sync the NVD CVE database
# TODO 2   : Write the result to Redis
# TODO 3   : Sync the NVD CPE database and Add search function
import json
from collections import defaultdict

CPE_CVE_MAPPING = defaultdict(set)


def getMapping(filename='nvdcve-1.0-modified.json'):
	with open(filename, 'r') as f:
		data = json.load(f)
		for cve_item in data['CVE_Items']:
			cve = cve_item["cve"]['CVE_data_meta']['ID']
			for cpe_node in cve_item['configurations']['nodes']:
				if 'cpe_match' not in cpe_node:
					continue
				for _ in cpe_node['cpe_match']:
					cpe = _['cpe23Uri']
					CPE_CVE_MAPPING[cpe].add(cve)


if __name__ == '__main__':
	getMapping()
	print(CPE_CVE_MAPPING)