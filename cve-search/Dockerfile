FROM ubuntu:20.04

EXPOSE 5000
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Etc/UTC
RUN apt-get update && \
    apt-get install -yqq \
      python3 \
      python3-pip \
      python3-dev \
      pkg-config \
      software-properties-common \
      git \
      vim \
      libxml2-dev \
      libxslt1-dev \
      zlib1g-dev \
      libffi7 \
      libssl-dev \
      libffi-dev \
      redis-server \
      wget \
      curl && \
      apt-get autoremove -y && \
      rm -rf /var/lib/apt/lists/*
RUN wget https://repo.mongodb.org/apt/ubuntu/dists/focal/mongodb-org/4.4/multiverse/binary-amd64/mongodb-org-server_4.4.15_amd64.deb && \
    wget https://repo.mongodb.org/apt/ubuntu/dists/focal/mongodb-org/4.4/multiverse/binary-amd64/mongodb-org-shell_4.4.15_amd64.deb && \
    wget https://repo.mongodb.org/apt/ubuntu/dists/focal/mongodb-org/4.4/multiverse/binary-amd64/mongodb-org-mongos_4.4.15_amd64.deb && \
    dpkg -i *.deb && \
    rm -rf *.deb
    
RUN mkdir -p /home/cve/db
WORKDIR /home/cve

RUN git clone https://github.com/cve-search/cve-search.git
WORKDIR /home/cve/cve-search
RUN git checkout v4.2.1
RUN pip3 install -r requirements.txt

RUN sed -i "s/bind .*/bind 127.0.0.1/g" /etc/redis/redis.conf
COPY ./scripts/db-init.sh .
RUN chmod a+x db-init.sh
RUN ./db-init.sh

COPY ./scripts/docker-entrypoint.sh .
COPY ./etc/configuration.ini ./etc/
COPY ./etc/sources.ini ./etc/
RUN chmod a+x ./docker-entrypoint.sh
ENTRYPOINT ["./docker-entrypoint.sh"]
